name: Ballerina CI/CD Pipeline

on: [push, pull_request]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Add environment variables for AKS configuration
    env:
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }} # Azure Resource Group where the AKS cluster is
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}     # Name of the AKS cluster
      # ðŸŽ¯ NEW: Define the namespace for deployment
      BALLERINA_NAMESPACE: balleina # You can change this to 'dev', 'staging', etc.

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1
        with:
          version: 2201.12.7

      - name: Cache Ballerina Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.ballerina
          key: ballerina-deps-${{ hashFiles('**/Ballerina.toml') }}
          restore-keys: |
            ballerina-deps-

      - name: Run Tests
        run: bal test

      - name: Build Ballerina Project (Generates K8s artifacts)
        # Ensure your Ballerina.toml or Cloud.toml is configured for K8s deployment
        run: bal build --cloud=kubernetes

      ## --- Docker Build and Push ---

      - name: Build Docker Image
        run: bal build --cloud=docker

      - name: Push Docker Image
        run: |
          # Use your Docker/ACR login credentials here
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push ramilu90/airline-service:1.0.0

      ## --- Azure Kubernetes Service (AKS) Deployment ---

      - name: ðŸ” Azure Login via Service Principal
        # This action uses a Service Principal JSON secret to authenticate with Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true
          
      - name: ðŸš¢ Set AKS Kubectl Context
        # This action retrieves and configures kubectl to communicate with the AKS cluster
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      - name: ðŸš€ Ensure Namespace Exists
        # It's best practice to ensure the namespace exists before deploying resources into it.
        run: |
          echo "Ensuring namespace ${{ env.BALLERINA_NAMESPACE }} exists..."
          # Use --ignore-not-found for idempotency: this won't fail if the namespace already exists.
          kubectl create namespace ${{ env.BALLERINA_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: ðŸ” Debug - Check Working Directory and Files
        run: |
          echo "Current working directory:"
          pwd
          echo ""
          echo "Listing all files recursively in current directory:"
          ls -R
          echo ""
          echo "Checking target/kubernetes directory specifically:"
          ls -R target/kubernetes 2>/dev/null || echo "target/kubernetes directory not found"
          
      - name: Deploy Kubernetes Resources with kubectl
        run: |
          echo "Applying Kubernetes manifests to namespace ${{ env.BALLERINA_NAMESPACE }} from target/kubernetes/hello_k8s..."
          # ðŸŽ¯ UPDATED: Use the -n flag to specify the namespace for the deployment
          kubectl apply -f target/kubernetes/airlineservice/airlineservice.yaml -n ${{ env.BALLERINA_NAMESPACE }}
          
          # Optional: Verify deployment status within the specified namespace
          echo "Deployment successful. Checking status in namespace ${{ env.BALLERINA_NAMESPACE }}:"
          kubectl get deployments -n ${{ env.BALLERINA_NAMESPACE }}