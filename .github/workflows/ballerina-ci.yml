name: Ballerina CI/CD Pipeline

on: [push, pull_request]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Add environment variables for AKS configuration
    env:
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }} # Azure Resource Group where the AKS cluster is
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}     # Name of the AKS cluster
      # üéØ FIX: Corrected typo in namespace name
      BALLERINA_NAMESPACE: ballerina # Changed 'balleina' to 'ballerina' or use your preferred name.

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Debug - Print Environment Variables
        run: |
          echo "Current Working Directory: $(pwd)"
          echo "AKS_RESOURCE_GROUP: ${{ env.AKS_RESOURCE_GROUP }}"
          echo "AKS_CLUSTER_NAME: ${{ env.AKS_CLUSTER_NAME }}"
          echo "BALLERINA_NAMESPACE: ${{ env.BALLERINA_NAMESPACE }}"
        
      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1
        with:
          version: 2201.12.7

      - name: Cache Ballerina Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.ballerina
          key: ballerina-deps-${{ hashFiles('**/Ballerina.toml') }}
          restore-keys: |
            ballerina-deps-

      - name: Run Tests
        run: bal test

      - name: Build Ballerina Project (Generates K8s artifacts)
        # Ensure your Ballerina.toml or Cloud.toml is configured for K8s deployment
        run: bal build

      ## --- Azure Kubernetes Service (AKS) Deployment ---

      - name: üîê Azure Login via Service Principal
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true
          
      - name: üö¢ Set AKS Kubectl Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      - name: üöÄ Ensure Namespace Exists (with Debug)
        run: |
          NAMESPACE="${{ env.BALLERINA_NAMESPACE }}"
          CREATE_COMMAND="kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -"
          
          echo "Checking if namespace ${NAMESPACE} exists..."
          if kubectl get namespace ${NAMESPACE} > /dev/null 2>&1; then
            echo "Namespace ${NAMESPACE} already exists. Skipping creation."
          else
            echo "Namespace ${NAMESPACE} does not exist. Creating it now..."
            echo "Executing command: ${CREATE_COMMAND}"
            # Execute the command to create the namespace idempotently
            eval ${CREATE_COMMAND}
          fi
          
          # Final check to confirm creation status
          echo "--- Current Namespace Status ---"
          kubectl get namespace ${NAMESPACE}
          echo "--------------------------------"

      - name: üîç Debug - Check Working Directory and Files
        run: |
          if [ -d "target/kubernetes" ]; then
            ls -la target/kubernetes
            echo "target/kubernetes directory exists."
            echo "location: "
            pwd
            echo "ls1: "
            ls /home/runner/work/airlineservice/airlineservice/target/kubernetes
            echo "ls2: "
            ls /home/runner/work/airlineservice/airlineservice/target/kubernetes/airlineservice
          else
            echo "target/kubernetes directory does NOT exist"
          fi
          
      - name: Deploy Kubernetes Resources with kubectl
        run: |
          kubectl apply -f /home/runner/work/airlineservice/airlineservice/target/kubernetes/airlineservice -n ${{ env.BALLERINA_NAMESPACE }}