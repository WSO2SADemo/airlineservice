name: Ballerina CI/CD Pipeline

on: [push, pull_request]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Add environment variables for AKS configuration
    env:
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }} # Azure Resource Group where the AKS cluster is
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}     # Name of the AKS cluster

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1
        with:
          version: 2201.12.7

      - name: Cache Ballerina Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.ballerina
          key: ballerina-deps-${{ hashFiles('**/Ballerina.toml') }}
          restore-keys: |
            ballerina-deps-

      - name: Run Tests
        run: bal test

      - name: Build Ballerina Project (Generates K8s artifacts)
        # Ensure your Ballerina.toml or Cloud.toml is configured for K8s deployment
        run: bal pack

      ## --- Docker Build and Push ---
      # Assuming you are pushing to Azure Container Registry (ACR) or Docker Hub

      - name: Build Docker Image
        run: bal build --cloud=docker

      - name: Push Docker Image
        run: |
          # Use your Docker/ACR login credentials here
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push airline-service:${{ github.sha }}

      # ## --- Azure Kubernetes Service (AKS) Deployment ---

      # - name: üîê Azure Login via Service Principal
      #   # This action uses a Service Principal JSON secret to authenticate with Azure
      #   uses: azure/login@v2
      #   with:
      #     creds: ${{ secrets.AZURE_CREDENTIALS }}
      #     enable-AzPSSession: true
          
      # - name: üö¢ Set AKS Kubectl Context
      #   # This action retrieves and configures kubectl to communicate with the AKS cluster
      #   uses: azure/aks-set-context@v3
      #   with:
      #     resource-group: ${{ env.AKS_RESOURCE_GROUP }}
      #     cluster-name: ${{ env.AKS_CLUSTER_NAME }}
          
      # - name: Deploy Kubernetes Resources with kubectl
      #   run: |
      #     echo "Applying Kubernetes manifests from target/kubernetes/hello_k8s..."
      #     # The main deployment command
      #     kubectl apply -f target/kubernetes/hello_k8s
          
      #     # Optional: Verify deployment status
      #     echo "Deployment successful. Checking status:"
      #     kubectl get deployments